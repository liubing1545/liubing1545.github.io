<!DOCTYPE html>


<html lang="zh-CN">
  

    <head>
      <meta charset="utf-8" />
        
      <meta
        name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1"
      />
      <title> 白兔之家</title>
  <meta name="generator" content="hexo-theme-ayer">
      
      <link rel="shortcut icon" href="/favicon.ico" />
       
<link rel="stylesheet" href="/dist/main.css">

      <link
        rel="stylesheet"
        href="https://cdn.jsdelivr.net/gh/Shen-Yu/cdn/css/remixicon.min.css"
      />
      
<link rel="stylesheet" href="/css/custom.css">
 
      <script src="https://cdn.jsdelivr.net/npm/pace-js@1.0.2/pace.min.js"></script>
       
 

      <!-- mermaid -->
      
    <link rel="alternate" href="/atom.xml" title="白兔之家" type="application/atom+xml">
</head>
  </html>
</html>


<body>
  <div id="app">
    
      
    <main class="content on">
      
<section class="cover">
    
  <div class="cover-frame">
    <div class="bg-box">
      <img src="/images/cover.jpg" alt="image frame" />
    </div>
    <div class="cover-inner text-center text-white">
      <h1><a href="/">白兔之家</a></h1>
      <div id="subtitle-box">
        
        <span id="subtitle"></span>
        
      </div>
      <div>
        
      </div>
    </div>
  </div>
  <div class="cover-learn-more">
    <a href="javascript:void(0)" class="anchor"><i class="ri-arrow-down-line"></i></a>
  </div>
</section>



<script src="https://cdn.jsdelivr.net/npm/typed.js@2.0.11/lib/typed.min.js"></script>


<!-- Subtitle -->

  <script>
    try {
      var typed = new Typed("#subtitle", {
        strings: ['爱神', '神也会爱你', '阿门'],
        startDelay: 0,
        typeSpeed: 200,
        loop: true,
        backSpeed: 100,
        showCursor: true
      });
    } catch (err) {
      console.log(err)
    }
  </script>
  
<div id="main">
  <section class="outer">
  
  
  

<div class="notice" style="margin-top:50px">
    <i class="ri-heart-fill"></i>
    <div class="notice-content" id="broad"></div>
</div>
<script type="text/javascript">
    fetch('https://v1.hitokoto.cn')
        .then(response => response.json())
        .then(data => {
            document.getElementById("broad").innerHTML = data.hitokoto;
        })
        .catch(console.error)
</script>

<style>
    .notice {
        padding: 20px;
        border: 1px dashed #e6e6e6;
        color: #969696;
        position: relative;
        display: inline-block;
        width: 100%;
        background: #fbfbfb50;
        border-radius: 10px;
    }

    .notice i {
        float: left;
        color: #999;
        font-size: 16px;
        padding-right: 10px;
        vertical-align: middle;
        margin-top: -2px;
    }

    .notice-content {
        display: initial;
        vertical-align: middle;
    }
</style>
  
  <article class="articles">
    
    
    
    
    <article
  id="post-gevent的异步方式"
  class="article article-type-post"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/2018/05/23/gevent%E7%9A%84%E5%BC%82%E6%AD%A5%E6%96%B9%E5%BC%8F/"
    >gevent的异步方式</a> 
</h2>
 

      
    </header>
     
    <div class="article-meta">
      <a href="/2018/05/23/gevent%E7%9A%84%E5%BC%82%E6%AD%A5%E6%96%B9%E5%BC%8F/" class="article-date">
  <time datetime="2018-05-23T09:23:11.000Z" itemprop="datePublished">2018-05-23</time>
</a>    
    </div>
      
    <div class="article-entry" itemprop="articleBody">
       
  <h2 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h2><p>gevent是基于协程的高性能Python网络库，相比Twisted、Stackless等，gevent使用libev事件循环，因此速度很快、性能很好，使用greenlet提供高层的同步API，因此非常轻量。<br>作者曾经是另一个Python网络库Eventlet的开发者之一，2009年因 为Eventlet无法满足项目需要，他决定另外开发一个更轻量的库，这就是gevent。某种意义上，gevent是从Eventlet项目派生出来的。    </p>
<h2 id="异步方式"><a href="#异步方式" class="headerlink" title="异步方式"></a>异步方式</h2><ul>
<li>gevent对标准I/O函数做了猴子补丁，把它们变成了异步。</li>
<li>并且gevent有greenlet对象能够被用于并发执行。</li>
</ul>
<h3 id="greenlet"><a href="#greenlet" class="headerlink" title="greenlet"></a>greenlet</h3><p>greenlet是一种协程。gevent的调度器在I/O等待期间使用一个事件循环在所有的greenlets间来回切换，而不是用多个CPU来运行它们。<br>gevent通过使用wait函数来设法尽可能透明化地处理事件循环。wait函数将启动一个事件循环，直到所有的greenlets结束。<br>greenlet由gevent.spawn(func, para)来创建，func是需要执行的函数，para是func的参数。一旦声明的函数执行完成，它的值就会包含在greenlet的value域中。    </p>
<h3 id="猴子补丁"><a href="#猴子补丁" class="headerlink" title="猴子补丁"></a>猴子补丁</h3><p>Monkey Patch就是在运行时对已有的代码进行修改，达到hot patch的目的。</p>
<h2 id="例子"><a href="#例子" class="headerlink" title="例子"></a>例子</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> gevent <span class="keyword">import</span> monkey; monkey.patch_all()</span><br><span class="line"><span class="keyword">import</span> gevent</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">f</span>(<span class="params">url</span>):</span></span><br><span class="line">	<span class="built_in">print</span>(<span class="string">&#x27;GET: %s&#x27;</span> % url)</span><br><span class="line">	headers = &#123;<span class="string">&#x27;User-Agent&#x27;</span>: <span class="string">&#x27;Mozilla/5.0&#x27;</span>&#125;</span><br><span class="line">	r = requests.get(url, headers = headers)</span><br><span class="line">	<span class="built_in">print</span>(<span class="string">&#x27;%d bytes received from %s.&#x27;</span> % (r.status_code, url))</span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">gevent.joinall([</span><br><span class="line">	gevent.spawn(f, <span class="string">&#x27;https://www.baidu.com&#x27;</span>), </span><br><span class="line">	gevent.spawn(f, <span class="string">&#x27;https://www.sina.com&#x27;</span>),</span><br><span class="line">	gevent.spawn(f, <span class="string">&#x27;http://www.douban.com&#x27;</span>)</span><br><span class="line">])</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>结果：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">(venv2) E:\github\concurrent&gt;python gevent2.py</span><br><span class="line">GET: https://www.baidu.com</span><br><span class="line">GET: https://www.sina.com</span><br><span class="line">GET: http://www.douban.com</span><br><span class="line">200 bytes received from https://www.baidu.com.</span><br><span class="line">200 bytes received from http://www.douban.com.</span><br><span class="line">200 bytes received from https://www.sina.com.</span><br></pre></td></tr></table></figure>
<h2 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h2><p>在部署web app的时候，用一个支持gevent的WSGI服务器，立刻就获得了数倍的性能提升。</p>
 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <footer class="article-footer">
       
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/gevent/" rel="tag">gevent</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%A4%9A%E5%B9%B6%E5%8F%91/" rel="tag">多并发</a></li></ul>

    </footer>
  </div>

    
 
    
</article>

    
    <article
  id="post-tornado的异步方式"
  class="article article-type-post"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/2018/05/22/tornado%E7%9A%84%E5%BC%82%E6%AD%A5%E6%96%B9%E5%BC%8F/"
    >tornado的异步方式</a> 
</h2>
 

      
    </header>
     
    <div class="article-meta">
      <a href="/2018/05/22/tornado%E7%9A%84%E5%BC%82%E6%AD%A5%E6%96%B9%E5%BC%8F/" class="article-date">
  <time datetime="2018-05-22T09:44:11.000Z" itemprop="datePublished">2018-05-22</time>
</a>    
    </div>
      
    <div class="article-entry" itemprop="articleBody">
       
  <h2 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h2><p>Tornado是Facebook主要为HTTP客户端和服务器端开发的异步I/O包。Tornado主要应对的是I/O密集型应用，Tornado可以使用协程和回调两种方式。<br>Tornado 优秀的大并发处理能力得益于它的 web server 从底层开始就自己实现了一整套基于 epoll 的单线程异步架构（其他 python web 框架的自带 server 基本是基于 wsgi 写的简单服务器，并没有自己实现底层结构）。</p>
<h2 id="epoll"><a href="#epoll" class="headerlink" title="epoll"></a>epoll</h2><p>ioloop 的实现基于 epoll ，那么什么是 epoll？ epoll 是Linux内核为处理大批量文件描述符而作了改进的 poll 。<br>那么什么又是 poll ？ 首先，我们回顾一下， socket 通信时的服务端，当它接受（ accept ）一个连接并建立通信后（ connection ）就进行通信，而此时我们并不知道连接的客户端有没有信息发完。 这时候我们有两种选择：</p>
<ol>
<li>一直在这里等着直到收发数据结束；</li>
<li>每隔一定时间来看看这里有没有数据；</li>
</ol>
<p>第二种办法要比第一种好一些，多个连接可以统一在一定时间内轮流看一遍里面有没有数据要读写，看上去我们可以处理多个连接了，这个方式就是 poll / select 的解决方案。     看起来似乎解决了问题，但实际上，随着连接越来越多，轮询所花费的时间将越来越长，而服务器连接的 socket 大多不是活跃的，所以轮询所花费的大部分时间将是无用的。为了解决这个问题， epoll 被创造出来，它的概念和 poll 类似，不过每次轮询时，他只会把有数据活跃的 socket 挑出来轮询，这样在有大量连接时轮询就节省了大量时间。</p>
<h2 id="tornado-ioloop"><a href="#tornado-ioloop" class="headerlink" title="tornado.ioloop"></a>tornado.ioloop</h2><p>ioloop 实际上是对 epoll 的封装，并加入了一些对上层事件的处理和 server 相关的底层处理。</p>
<h2 id="协程"><a href="#协程" class="headerlink" title="协程"></a>协程</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> tornado <span class="keyword">import</span> gen</span><br><span class="line"></span><br><span class="line"><span class="meta">@gen.coroutine</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">fetch_coroutine</span>(<span class="params">url</span>):</span></span><br><span class="line">    http_client = AsyncHTTPClient()</span><br><span class="line">    response = <span class="keyword">yield</span> http_client.fetch(url)</span><br><span class="line">    <span class="comment">#为了返回值，python2中需要生成一个特殊的异常；在python3.3以后直接用return</span></span><br><span class="line">    <span class="keyword">raise</span> gen.Return(response.body)</span><br></pre></td></tr></table></figure>
<ul>
<li>@gen.coroutine 和 yield 搭配使用，代表的是协成。</li>
<li>yield之后挂起耗时操作，耗时操作完成时从挂起的位置接着往下执行。</li>
<li>Tornado的协成是由python的generators来支持的。</li>
</ul>
<h2 id="回调"><a href="#回调" class="headerlink" title="回调"></a>回调</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> tornado.httpclient <span class="keyword">import</span> AsyncHTTPClient</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">asynchronous_fetch</span>(<span class="params">url, callback</span>):</span></span><br><span class="line">    http_client = AsyncHTTPClient()</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">handle_response</span>(<span class="params">response</span>):</span></span><br><span class="line">        callback(response.body)</span><br><span class="line">    http_client.fetch(url, callback=handle_response)</span><br></pre></td></tr></table></figure>
<ul>
<li>http_client第二个参数callback指定了回调函数。</li>
<li>多重的显式的回调容易引起“回调地狱”。</li>
</ul>
 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <footer class="article-footer">
       
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/tornado/" rel="tag">tornado</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%A4%9A%E5%B9%B6%E5%8F%91/" rel="tag">多并发</a></li></ul>

    </footer>
  </div>

    
 
    
</article>

    
    <article
  id="post-刷票"
  class="article article-type-post"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/2018/05/18/%E5%88%B7%E7%A5%A8/"
    >刷票</a> 
</h2>
 

      
    </header>
     
    <div class="article-meta">
      <a href="/2018/05/18/%E5%88%B7%E7%A5%A8/" class="article-date">
  <time datetime="2018-05-18T08:17:11.000Z" itemprop="datePublished">2018-05-18</time>
</a>    
    </div>
      
    <div class="article-entry" itemprop="articleBody">
       
  <p>给小朋友投票，拉微信朋友圈的朋友点赞什么的好麻烦啊。索性把分享的页面url拉到浏览器上研究一下，发条http post把data拿出来，直接post到目标地址不就ok了。开搞。</p>
<h2 id="安装requests"><a href="#安装requests" class="headerlink" title="安装requests"></a>安装requests</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install requests</span><br></pre></td></tr></table></figure>

<h2 id="主要代码"><a href="#主要代码" class="headerlink" title="主要代码"></a>主要代码</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">get_cookie=requests.get(<span class="string">&quot;https://aa.rrxiu.cc/v/4uj43w?vt=1&amp;from_code=3c2953a3680daf86bfdb76cef13d2572&amp;guid97=d8c3e2e1aee2be5b35e571711865189f-162498&amp;from=timeline&amp;isappinstalled=0&quot;</span>)</span><br><span class="line">data=&#123;<span class="string">&#x27;wsiteGuid&#x27;</span>:<span class="string">&#x27;4uj43w&#x27;</span>,<span class="string">&#x27;wxOpenId&#x27;</span>:<span class="string">&#x27;&#x27;</span>,<span class="string">&#x27;nickName&#x27;</span>:<span class="string">&#x27;&#x27;</span>,<span class="string">&#x27;headimgurl&#x27;</span>:<span class="string">&#x27;&#x27;</span>,<span class="string">&#x27;guid&#x27;</span>:<span class="string">&#x27;d8c3e2e1aee2be5b35e571711865189f&#x27;</span>,<span class="string">&#x27;id&#x27;</span>:<span class="string">&#x27;162498&#x27;</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">100</span>):</span><br><span class="line">    r = requests.post(<span class="string">&#x27;https://res2.rrxiu.net/pluginPhotoVote/photoVoteData/vote&#x27;</span>,cookies=get_cookie.cookies,data=data)</span><br><span class="line">    <span class="built_in">print</span>(r.text)</span><br></pre></td></tr></table></figure>
 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <footer class="article-footer">
       
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/requests/" rel="tag">requests</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%88%B7%E7%A5%A8/" rel="tag">刷票</a></li></ul>

    </footer>
  </div>

    
 
    
</article>

    
    <article
  id="post-celery介绍"
  class="article article-type-post"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/2018/05/10/celery%E4%BB%8B%E7%BB%8D/"
    >celery介绍</a> 
</h2>
 

      
    </header>
     
    <div class="article-meta">
      <a href="/2018/05/10/celery%E4%BB%8B%E7%BB%8D/" class="article-date">
  <time datetime="2018-05-10T06:47:11.000Z" itemprop="datePublished">2018-05-10</time>
</a>    
    </div>
      
    <div class="article-entry" itemprop="articleBody">
       
  <h2 id="Celery架构设计"><a href="#Celery架构设计" class="headerlink" title="Celery架构设计"></a>Celery架构设计</h2><p>Celery是一个用python编写的分布式的任务调度模块，它有着简明的 API，并且有丰富的扩展性，适合用于构建分布式的 Web 服务。celery的架构包括三个部分：消息中间件（message broker），任务执行单元（worker）和任务执行结果的存储（task result store）。</p>
<h4 id="消息中间件"><a href="#消息中间件" class="headerlink" title="消息中间件"></a>消息中间件</h4><p>celery本身不提供消息服务，但可以和第三方提供的消息中间件（<strong>RabbitMQ</strong>,<strong>Redis</strong>等）集成。</p>
<h4 id="任务执行单元"><a href="#任务执行单元" class="headerlink" title="任务执行单元"></a>任务执行单元</h4><p>worker是celery提供的任务执行单元，worker并发的运行在分布式的系统节点中。</p>
<h4 id="任务结果存储"><a href="#任务结果存储" class="headerlink" title="任务结果存储"></a>任务结果存储</h4><p>task result store用来存储worker执行的任务的结果，celery支持以不同方式存储任务的结果（<strong>AMQP</strong>,<strong>Redis</strong>,<strong>MongoDB</strong>）。</p>
<p>另外，celery还支持不同的并发（<strong>Prefork</strong>,<strong>Eventlet</strong>,<strong>gevent</strong>,<strong>threads</strong>）和序列化的手段（<strong>pickle</strong>,<strong>json</strong>,<strong>yaml</strong>等）。</p>
<h2 id="概图"><a href="#概图" class="headerlink" title="概图"></a>概图</h2><p><img src="http://obksgg9lx.bkt.clouddn.com/celery.png" alt="celery"></p>
<h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pip install celery</span><br><span class="line">pip install redis</span><br></pre></td></tr></table></figure>

<h2 id="应用"><a href="#应用" class="headerlink" title="应用"></a>应用</h2><h4 id="消息中间件redis的配置-及任务结果存储"><a href="#消息中间件redis的配置-及任务结果存储" class="headerlink" title="消息中间件redis的配置,及任务结果存储"></a>消息中间件redis的配置,及任务结果存储</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">CELERY_BROKER_URL = <span class="string">&#x27;redis://localhost:6379/0&#x27;</span></span><br><span class="line">CELERY_RESULT_BACKEND = <span class="string">&#x27;redis://localhost:6379/0&#x27;</span></span><br><span class="line"><span class="comment"># 使用 update设置多个celery的参数</span></span><br><span class="line">celery.conf.update(app.config)</span><br></pre></td></tr></table></figure>

<h4 id="消费者task"><a href="#消费者task" class="headerlink" title="消费者task"></a>消费者task</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@celery.task(<span class="params">bind=<span class="literal">True</span></span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">long_task</span>(<span class="params">self</span>):</span></span><br><span class="line">    <span class="comment"># 执行耗费资源的算法</span></span><br><span class="line">    algorithm.reset_data()</span><br><span class="line"></span><br><span class="line">    app = create_app(os.getenv(<span class="string">&#x27;FLASK_CONFIG&#x27;</span>) <span class="keyword">or</span> <span class="string">&#x27;default&#x27;</span>)</span><br><span class="line">    <span class="keyword">with</span> app.app_context():</span><br><span class="line">        front_data = algorithm.run_search(algorithm.TestData.requirement, algorithm.TestData.disabled_devices)</span><br><span class="line">        <span class="keyword">import</span> json</span><br><span class="line">        </span><br><span class="line">        data = json.dumps(front_data)</span><br><span class="line">        <span class="keyword">return</span> &#123;<span class="string">&#x27;current&#x27;</span>: <span class="number">100</span>, <span class="string">&#x27;total&#x27;</span>: <span class="number">100</span>, <span class="string">&#x27;status&#x27;</span>: <span class="string">&#x27;Task completed!&#x27;</span>, <span class="string">&#x27;result&#x27;</span>: data&#125;</span><br></pre></td></tr></table></figure>

<h4 id="通过task-apply-async将任务压入消息队列broker中"><a href="#通过task-apply-async将任务压入消息队列broker中" class="headerlink" title="通过task.apply_async将任务压入消息队列broker中"></a>通过task.apply_async将任务压入消息队列broker中</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@energy_island.route(<span class="params"><span class="string">&#x27;/get_graph_data&#x27;</span>, methods=[<span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="meta">@login_required</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_graph_data</span>():</span></span><br><span class="line">    <span class="built_in">id</span> = request.values.get(<span class="string">&#x27;id&#x27;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">id</span>)</span><br><span class="line"></span><br><span class="line">    task = tasks.long_task.apply_async()</span><br><span class="line">    <span class="keyword">return</span> jsonify(&#123;&#125;), <span class="number">202</span>, &#123;<span class="string">&#x27;Location&#x27;</span>: url_for(<span class="string">&#x27;energy_island.taskstatus&#x27;</span>, task_id=task.<span class="built_in">id</span>)&#125;</span><br></pre></td></tr></table></figure>

<h4 id="使用backend异步获取结果task-AsyncResult"><a href="#使用backend异步获取结果task-AsyncResult" class="headerlink" title="使用backend异步获取结果task.AsyncResult"></a>使用backend异步获取结果task.AsyncResult</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@energy_island.route(<span class="params"><span class="string">&#x27;/status/&lt;task_id&gt;&#x27;</span></span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">taskstatus</span>(<span class="params">task_id</span>):</span></span><br><span class="line">    task = tasks.long_task.AsyncResult(task_id)</span><br><span class="line">    <span class="keyword">if</span> task.state == <span class="string">&#x27;PENDING&#x27;</span>:</span><br><span class="line">        response = &#123;</span><br><span class="line">            <span class="string">&#x27;state&#x27;</span>: task.state,</span><br><span class="line">            <span class="string">&#x27;current&#x27;</span>: <span class="number">0</span>,</span><br><span class="line">            <span class="string">&#x27;total&#x27;</span>: <span class="number">1</span>,</span><br><span class="line">            <span class="string">&#x27;status&#x27;</span>: <span class="string">&#x27;Pending...&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line">    <span class="keyword">elif</span> task.state != <span class="string">&#x27;FAILURE&#x27;</span>:</span><br><span class="line">        response = &#123;</span><br><span class="line">            <span class="string">&#x27;state&#x27;</span>: task.state,</span><br><span class="line">            <span class="string">&#x27;current&#x27;</span>: task.info.get(<span class="string">&#x27;current&#x27;</span>, <span class="number">0</span>),</span><br><span class="line">            <span class="string">&#x27;total&#x27;</span>: task.info.get(<span class="string">&#x27;total&#x27;</span>, <span class="number">1</span>),</span><br><span class="line">            <span class="string">&#x27;status&#x27;</span>: task.info.get(<span class="string">&#x27;status&#x27;</span>, <span class="string">&#x27; &#x27;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> <span class="string">&#x27;result&#x27;</span> <span class="keyword">in</span> task.info:</span><br><span class="line">            response[<span class="string">&#x27;result&#x27;</span>] = task.info[<span class="string">&#x27;result&#x27;</span>]</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        response = &#123;</span><br><span class="line">            <span class="string">&#x27;state&#x27;</span>: task.state,</span><br><span class="line">            <span class="string">&#x27;current&#x27;</span>: <span class="number">1</span>,</span><br><span class="line">            <span class="string">&#x27;total&#x27;</span>: <span class="number">1</span>,</span><br><span class="line">            <span class="string">&#x27;status&#x27;</span>: <span class="built_in">str</span>(task.info),</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="keyword">return</span> jsonify(response)</span><br></pre></td></tr></table></figure>

<h4 id="生产者get消费者完成的状态"><a href="#生产者get消费者完成的状态" class="headerlink" title="生产者get消费者完成的状态"></a>生产者get消费者完成的状态</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> update_progress = <span class="function"><span class="keyword">function</span>(<span class="params">status_url</span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// send GET request to status URL</span></span><br><span class="line">    $.getJSON(status_url, <span class="function"><span class="keyword">function</span>(<span class="params">data</span>) </span>&#123;</span><br><span class="line">        <span class="comment">// update UI</span></span><br><span class="line">        percent = <span class="built_in">parseInt</span>(data[<span class="string">&#x27;current&#x27;</span>] * <span class="number">100</span> / data[<span class="string">&#x27;total&#x27;</span>]);</span><br><span class="line">        <span class="keyword">if</span> (data[<span class="string">&#x27;state&#x27;</span>] != <span class="string">&#x27;PENDING&#x27;</span> &amp;&amp; data[<span class="string">&#x27;state&#x27;</span>] != <span class="string">&#x27;PROGRESS&#x27;</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="string">&#x27;result&#x27;</span> <span class="keyword">in</span> data) &#123;</span><br><span class="line"></span><br><span class="line">                setGraphDataRun(<span class="built_in">JSON</span>.parse(data[<span class="string">&#x27;result&#x27;</span>]), <span class="number">1</span>);</span><br><span class="line">                <span class="comment">// show result</span></span><br><span class="line">                alert(<span class="string">&#x27;result-liubing: &#x27;</span> + data[<span class="string">&#x27;result&#x27;</span>]);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                alert(<span class="string">&#x27;state-liubing: &#x27;</span> + data[<span class="string">&#x27;state&#x27;</span>]);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// rerun in 2 seconds</span></span><br><span class="line">            <span class="built_in">setTimeout</span>(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">                update_progress(status_url);</span><br><span class="line">            &#125;, <span class="number">2000</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="启动celery"><a href="#启动celery" class="headerlink" title="启动celery"></a>启动celery</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">celery -A app.celery worker -l info -P eventlet</span><br></pre></td></tr></table></figure>
 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <footer class="article-footer">
       
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/celery/" rel="tag">celery</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%88%86%E5%B8%83%E5%BC%8F/" rel="tag">分布式</a></li></ul>

    </footer>
  </div>

    
 
    
</article>

    
    <article
  id="post-为Jupyter Notebook添加目录"
  class="article article-type-post"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/2018/04/24/%E4%B8%BAJupyter%20Notebook%E6%B7%BB%E5%8A%A0%E7%9B%AE%E5%BD%95/"
    >为Jupyter Notebook添加目录</a> 
</h2>
 

      
    </header>
     
    <div class="article-meta">
      <a href="/2018/04/24/%E4%B8%BAJupyter%20Notebook%E6%B7%BB%E5%8A%A0%E7%9B%AE%E5%BD%95/" class="article-date">
  <time datetime="2018-04-24T03:45:11.000Z" itemprop="datePublished">2018-04-24</time>
</a>    
    </div>
      
    <div class="article-entry" itemprop="articleBody">
       
  <p> 为Jupyter Notebook生成目录，需要安装插件Jupyter notebook extensions：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> conda install -c conda-forge jupyter_contrib_nbextensions</span></span><br></pre></td></tr></table></figure>

<p>重启jupyter notebook，可以将代码中插入的markdown文字，采集成左侧目录。并可根据需求进行设置。</p>
<p><img src="http://obksgg9lx.bkt.clouddn.com/notebook-extension.png" alt="notebook-extension"></p>
 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <footer class="article-footer">
       
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ai/" rel="tag">ai</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/jupyter-notebook/" rel="tag">jupyter notebook</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/keras/" rel="tag">keras</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/python/" rel="tag">python</a></li></ul>

    </footer>
  </div>

    
 
    
</article>

    
    <article
  id="post-利用AppVeyor做GithubIO的CI"
  class="article article-type-post"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/2018/04/24/%E5%88%A9%E7%94%A8AppVeyor%E5%81%9AGithubIO%E7%9A%84CI/"
    >利用AppVeyor做GithubIO的CI</a> 
</h2>
 

      
    </header>
     
    <div class="article-meta">
      <a href="/2018/04/24/%E5%88%A9%E7%94%A8AppVeyor%E5%81%9AGithubIO%E7%9A%84CI/" class="article-date">
  <time datetime="2018-04-24T03:45:11.000Z" itemprop="datePublished">2018-04-24</time>
</a>    
    </div>
      
    <div class="article-entry" itemprop="articleBody">
       
  <h2 id="建立两个仓库"><a href="#建立两个仓库" class="headerlink" title="建立两个仓库"></a>建立两个仓库</h2><p>我基于hexo搭建的github.io，在更换电脑时无法随意的提交blog。（因每个机器都需要部署node+hexo的环境）<br>于是，我将我的github.io建立两个仓库。</p>
<ul>
<li>master仓库（hexo generate后生成的html等文件）</li>
<li>hexo仓库（原始文件，包含md文档及主题等）</li>
</ul>
<p>并将hexo仓库设置为这个repo的主仓库。</p>
<h2 id="AppVeyor"><a href="#AppVeyor" class="headerlink" title="AppVeyor"></a>AppVeyor</h2><p><a target="_blank" rel="noopener" href="https://www.appveyor.com/">appveyor</a>是支持windows OS做CI的持续集成工具，可以使用GitHub账号登陆。绑定我的github.io项目。</p>
<h4 id="添加appveyor-yml到Source-Repo"><a href="#添加appveyor-yml到Source-Repo" class="headerlink" title="添加appveyor.yml到Source Repo"></a>添加appveyor.yml到Source Repo</h4><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">clone_depth:</span> <span class="number">5</span></span><br><span class="line"></span><br><span class="line"><span class="attr">environment:</span></span><br><span class="line">  <span class="attr">access_token:</span></span><br><span class="line">    <span class="attr">secure:</span> [<span class="string">Your</span> <span class="string">Github</span> <span class="string">Access</span> <span class="string">Token</span>]</span><br><span class="line"></span><br><span class="line"><span class="attr">install:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">ps:</span> <span class="string">Install-Product</span> <span class="string">node</span> <span class="number">6</span> <span class="comment">#因为我的hexo是3.71的版本，因此需要安装node 6</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">node</span> <span class="string">--version</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">npm</span> <span class="string">--version</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">npm</span> <span class="string">install</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">npm</span> <span class="string">install</span> <span class="string">hexo-cli</span> <span class="string">-g</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="attr">build_script:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">hexo</span> <span class="string">generate</span></span><br><span class="line"></span><br><span class="line"><span class="attr">artifacts:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">public</span></span><br><span class="line"></span><br><span class="line"><span class="attr">on_success:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">git</span> <span class="string">config</span> <span class="string">--global</span> <span class="string">credential.helper</span> <span class="string">store</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">ps:</span> <span class="string">Add-Content</span> <span class="string">&quot;$env:USERPROFILE\.git-credentials&quot;</span> <span class="string">&quot;https://$($env:access_token):x-oauth-basic@github.com`n&quot;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">git</span> <span class="string">config</span> <span class="string">--global</span> <span class="string">user.email</span> <span class="string">&quot;%GIT_USER_EMAIL%&quot;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">git</span> <span class="string">config</span> <span class="string">--global</span> <span class="string">user.name</span> <span class="string">&quot;%GIT_USER_NAME%&quot;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">git</span> <span class="string">clone</span> <span class="string">--depth</span> <span class="number">5</span> <span class="string">-q</span> <span class="string">--branch=%TARGET_BRANCH%</span> <span class="string">%STATIC_SITE_REPO%</span> <span class="string">%TEMP%\static-site</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">cd</span> <span class="string">%TEMP%\static-site</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">del</span> <span class="string">*</span> <span class="string">/f</span> <span class="string">/q</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">for</span> <span class="string">/d</span> <span class="string">%%p</span> <span class="string">IN</span> <span class="string">(*)</span> <span class="string">do</span> <span class="string">rmdir</span> <span class="string">&quot;%%p&quot;</span> <span class="string">/s</span> <span class="string">/q</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">SETLOCAL</span> <span class="string">EnableDelayedExpansion</span> <span class="string">&amp;</span> <span class="string">robocopy</span> <span class="string">&quot;%APPVEYOR_BUILD_FOLDER%\public&quot;</span> <span class="string">&quot;%TEMP%\static-site&quot;</span> <span class="string">/e</span> <span class="string">&amp;</span> <span class="string">IF</span> <span class="type">!ERRORLEVEL</span><span class="string">!</span> <span class="string">EQU</span> <span class="number">1</span> <span class="string">(exit</span> <span class="number">0</span><span class="string">)</span> <span class="string">ELSE</span> <span class="string">(IF</span> <span class="type">!ERRORLEVEL</span><span class="string">!</span> <span class="string">EQU</span> <span class="number">3</span> <span class="string">(exit</span> <span class="number">0</span><span class="string">)</span> <span class="string">ELSE</span> <span class="string">(exit</span> <span class="number">1</span><span class="string">))</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">git</span> <span class="string">add</span> <span class="string">-A</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">git</span> <span class="string">commit</span> <span class="string">-m</span> <span class="string">&quot;Update Static Site&quot;</span> <span class="string">&amp;&amp;</span> <span class="string">git</span> <span class="string">push</span> <span class="string">origin</span> <span class="string">%TARGET_BRANCH%</span> <span class="string">&amp;&amp;</span> <span class="string">appveyor</span> <span class="string">AddMessage</span> <span class="string">&quot;Static Site Updated&quot;</span></span><br></pre></td></tr></table></figure>
<p>在GitHub生成好Access Token之后，你需要到<a target="_blank" rel="noopener" href="https://ci.appveyor.com/tools/encrypt">AppVeyor加密页面</a>把Access Token加密之后再替换[Your GitHub Access Token]。<br><img src="http://obksgg9lx.bkt.clouddn.com/github-access-token.png" alt="github-access-token"><br><img src="http://obksgg9lx.bkt.clouddn.com/github-webhook.png" alt="github-webhook"></p>
<h4 id="设置Appveyor的settings"><a href="#设置Appveyor的settings" class="headerlink" title="设置Appveyor的settings"></a>设置Appveyor的settings</h4><p><img src="http://obksgg9lx.bkt.clouddn.com/appveyor-setting1-.jpg" alt="appveyor-setting1"><br>在Appveyor Settings的Environment里设置以下四个变量。STATIC_SITE_REPO就是github Repo的地址，TARGET_BRANCH是Repo的目标branch（这里是master，相当于提交编译后的html等文件至master），GIT_USER_EMAIL和GIT_USER_NAME就是你GitHub账号的信息。<br><img src="http://obksgg9lx.bkt.clouddn.com/appveyor-setting2-.jpg" alt="appveyor-setting2"><br>在Appveyor Settings的build里默认是MSBUILD，因为是appveyor.yml中配置的脚本来build的，因此这里改成SCRIPT。<br><img src="http://obksgg9lx.bkt.clouddn.com/appveyor-setting3.png" alt="appveyor-setting3"></p>
<h2 id="整体逻辑"><a href="#整体逻辑" class="headerlink" title="整体逻辑"></a>整体逻辑</h2><p>本地在hexo的分支下写md文档，提交至github上，触发AppVeyor的webhook，AppVeyor会git clone下hexo的最新代码，并且build成目标文件，将目标文件push至master分支。则完成了整体刷新页面，持续部署的工作了。<br>可以在线监控build的状况：<br><img src="http://obksgg9lx.bkt.clouddn.com/appveyor-build-log.png" alt="appveyor-build-log"></p>
 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <footer class="article-footer">
       
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/AppVeyor/" rel="tag">AppVeyor</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/CI/" rel="tag">CI</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/github/" rel="tag">github</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/hexo/" rel="tag">hexo</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E6%8C%81%E7%BB%AD%E9%83%A8%E7%BD%B2/" rel="tag">持续部署</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E6%8C%81%E7%BB%AD%E9%9B%86%E6%88%90/" rel="tag">持续集成</a></li></ul>

    </footer>
  </div>

    
 
    
</article>

    
    <article
  id="post-git删除所有提交历史记录"
  class="article article-type-post"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/2018/04/20/git%E5%88%A0%E9%99%A4%E6%89%80%E6%9C%89%E6%8F%90%E4%BA%A4%E5%8E%86%E5%8F%B2%E8%AE%B0%E5%BD%95/"
    >git删除所有提交历史记录</a> 
</h2>
 

      
    </header>
     
    <div class="article-meta">
      <a href="/2018/04/20/git%E5%88%A0%E9%99%A4%E6%89%80%E6%9C%89%E6%8F%90%E4%BA%A4%E5%8E%86%E5%8F%B2%E8%AE%B0%E5%BD%95/" class="article-date">
  <time datetime="2018-04-20T02:53:25.000Z" itemprop="datePublished">2018-04-20</time>
</a>    
    </div>
      
    <div class="article-entry" itemprop="articleBody">
       
  <h2 id="checkout"><a href="#checkout" class="headerlink" title="checkout"></a>checkout</h2>   <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git checkout --orphan latest_branch</span><br></pre></td></tr></table></figure>

<h2 id="添加所有文件"><a href="#添加所有文件" class="headerlink" title="添加所有文件"></a>添加所有文件</h2>   <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git add -A</span><br></pre></td></tr></table></figure>
<p>   ​</p>
<h2 id="提交变更"><a href="#提交变更" class="headerlink" title="提交变更"></a>提交变更</h2>   <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git commit -am &quot;something about message&quot;</span><br></pre></td></tr></table></figure>
<p>   ​</p>
<h2 id="删除分支"><a href="#删除分支" class="headerlink" title="删除分支"></a>删除分支</h2>   <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git branch -D master</span><br></pre></td></tr></table></figure>
<p>   ​</p>
<h2 id="重命名当前branch为目标名"><a href="#重命名当前branch为目标名" class="headerlink" title="重命名当前branch为目标名"></a>重命名当前branch为目标名</h2>   <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git branch -m master</span><br></pre></td></tr></table></figure>

<p>   ​</p>
<h2 id="强制push"><a href="#强制push" class="headerlink" title="强制push"></a>强制push</h2>   <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git push -f origin master</span><br></pre></td></tr></table></figure>
<p>   ​</p>
 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <footer class="article-footer">
       
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/git/" rel="tag">git</a></li></ul>

    </footer>
  </div>

    
 
    
</article>

    
    <article
  id="post-centos7安装postgresql"
  class="article article-type-post"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/2017/12/07/centos7%E5%AE%89%E8%A3%85postgresql/"
    >centos7安装postgresql</a> 
</h2>
 

      
    </header>
     
    <div class="article-meta">
      <a href="/2017/12/07/centos7%E5%AE%89%E8%A3%85postgresql/" class="article-date">
  <time datetime="2017-12-07T08:13:46.000Z" itemprop="datePublished">2017-12-07</time>
</a>    
    </div>
      
    <div class="article-entry" itemprop="articleBody">
       
  <h2 id="安装启动postgresql"><a href="#安装启动postgresql" class="headerlink" title="安装启动postgresql"></a>安装启动postgresql</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">yum install postgresql-server</span><br><span class="line">service postgresql initdb</span><br><span class="line">service postgresql start</span><br></pre></td></tr></table></figure>
<h2 id="修改管理员密码"><a href="#修改管理员密码" class="headerlink" title="修改管理员密码"></a>修改管理员密码</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">su - postgres</span><br><span class="line">psql</span><br><span class="line"><span class="meta">$</span><span class="bash"> ALTER USER postgres WITH PASSWORD <span class="string">&#x27;postgres&#x27;</span>;</span></span><br></pre></td></tr></table></figure>

<h2 id="配置远程访问"><a href="#配置远程访问" class="headerlink" title="配置远程访问"></a>配置远程访问</h2><p>修改**/var/lib/pgsql/data/postgresql.conf**</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">listen_addresses = &#x27;*&#x27;</span><br></pre></td></tr></table></figure>

<p>修改客户端认证配置文件**/var/lib/pgsql/data/pg_hba.conf**,添加</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">host  all  all   10.0.0.0/8  md5</span><br></pre></td></tr></table></figure>

<h2 id="重启服务"><a href="#重启服务" class="headerlink" title="重启服务"></a>重启服务</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">service postgresql restart</span><br></pre></td></tr></table></figure>
 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <footer class="article-footer">
       
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/centos7/" rel="tag">centos7</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/postgresql/" rel="tag">postgresql</a></li></ul>

    </footer>
  </div>

    
 
    
</article>

    
    <article
  id="post-配置gitbucket的webhook触发jenkins自动构建"
  class="article article-type-post"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/2017/11/20/%E9%85%8D%E7%BD%AEgitbucket%E7%9A%84webhook%E8%A7%A6%E5%8F%91jenkins%E8%87%AA%E5%8A%A8%E6%9E%84%E5%BB%BA/"
    >配置gitbucket的webhook触发jenkins自动构建</a> 
</h2>
 

      
    </header>
     
    <div class="article-meta">
      <a href="/2017/11/20/%E9%85%8D%E7%BD%AEgitbucket%E7%9A%84webhook%E8%A7%A6%E5%8F%91jenkins%E8%87%AA%E5%8A%A8%E6%9E%84%E5%BB%BA/" class="article-date">
  <time datetime="2017-11-20T04:10:22.000Z" itemprop="datePublished">2017-11-20</time>
</a>    
    </div>
      
    <div class="article-entry" itemprop="articleBody">
       
  <h2 id="jenkins安装gitbucket插件"><a href="#jenkins安装gitbucket插件" class="headerlink" title="jenkins安装gitbucket插件"></a>jenkins安装gitbucket插件</h2><p>在jenkins中安装插件:<strong>Gitbucket Plugin</strong><br>安装好了之后配置构建触发器。<br><img src="http://obksgg9lx.bkt.clouddn.com/triggle.png" alt="构建触发器"></p>
<h2 id="gitbucket设置webhook"><a href="#gitbucket设置webhook" class="headerlink" title="gitbucket设置webhook"></a>gitbucket设置webhook</h2><p>使用root管理员账户进入需要设置webhook的具体项目中Settings-&gt;Service Hooks菜单下，配置gitbucket的webhook。<br><img src="http://obksgg9lx.bkt.clouddn.com/gitbucket.png" alt="配置webhook"></p>
<h2 id="自动触发"><a href="#自动触发" class="headerlink" title="自动触发"></a>自动触发</h2><p>source提交git。<br><img src="http://obksgg9lx.bkt.clouddn.com/push-status.png" alt="push状态"></p>
<p>自动触发构建。<br><img src="http://obksgg9lx.bkt.clouddn.com/console.png" alt="自动构建"></p>
 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <footer class="article-footer">
       
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/gitbucket/" rel="tag">gitbucket</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/jenkins/" rel="tag">jenkins</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/webhook/" rel="tag">webhook</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E6%8C%81%E7%BB%AD%E9%83%A8%E7%BD%B2/" rel="tag">持续部署</a></li></ul>

    </footer>
  </div>

    
 
    
</article>

    
    <article
  id="post-jenkins自动部署docker应用"
  class="article article-type-post"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/2017/11/17/jenkins%E8%87%AA%E5%8A%A8%E9%83%A8%E7%BD%B2docker%E5%BA%94%E7%94%A8/"
    >jenkins自动部署docker应用</a> 
</h2>
 

      
    </header>
     
    <div class="article-meta">
      <a href="/2017/11/17/jenkins%E8%87%AA%E5%8A%A8%E9%83%A8%E7%BD%B2docker%E5%BA%94%E7%94%A8/" class="article-date">
  <time datetime="2017-11-17T10:29:54.000Z" itemprop="datePublished">2017-11-17</time>
</a>    
    </div>
      
    <div class="article-entry" itemprop="articleBody">
       
  <h2 id="项目背景"><a href="#项目背景" class="headerlink" title="项目背景"></a>项目背景</h2><p>目前需要部署一个基于python flask的web服务，数据库使用的是postgresql。</p>
<h2 id="思路-amp-流程"><a href="#思路-amp-流程" class="headerlink" title="思路&amp;流程"></a>思路&amp;流程</h2><ul>
<li>准备docker镜像</li>
<li>jenkins拉取远端源码–git</li>
<li>实现应用打包–jenkins本地</li>
<li>把应用打包进docker镜像–dockerfile</li>
<li>镜像同步到docker私有仓库–shell docker命令</li>
<li>删除老的docker容器–shell docker命令</li>
<li>运行新的docker容器–shell docker命令</li>
</ul>
<h3 id="准备docker镜像"><a href="#准备docker镜像" class="headerlink" title="准备docker镜像"></a>准备docker镜像</h3><h4 id="创建自定义flask镜像"><a href="#创建自定义flask镜像" class="headerlink" title="创建自定义flask镜像"></a>创建自定义flask镜像</h4><p>基于<strong>tiangolo/uwsgi-nginx-flask</strong>创建flask的镜像。<br>自定义flask镜像的dockerfile:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">FROM tiangolo/uwsgi-nginx-flask:python2.7</span><br><span class="line"></span><br><span class="line">COPY ./app /app</span><br><span class="line">COPY ./lib/libseuif97.so /usr/lib</span><br><span class="line">RUN pip install -r requirements.txt</span><br></pre></td></tr></table></figure>

<p>因为网络环境不好，安装requirements.txt中python的第三方库时，发生报错，因此我将基本的库事先安装好。<br>并且把需要的so静态文件也COPY进镜像中。<br>后面如果有变化，可以根据需要在jenkins中再动态生成dockerfile并执行。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker build -t test-flask .</span><br></pre></td></tr></table></figure>

<h4 id="创建自定义的postgresql"><a href="#创建自定义的postgresql" class="headerlink" title="创建自定义的postgresql"></a>创建自定义的postgresql</h4><p>自定义postgresql镜像的dockerfile:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">FROM postgres:9.3</span><br><span class="line"></span><br><span class="line">ADD ./sql /docker-entrypoint-initdb.d/</span><br></pre></td></tr></table></figure>
<p>我们有一些master表，以及基础数据，我们需要在运行这个容器之前，将这些基础数据insert进db这个docker之中。<br>可以把各种sql文件放入/sql路径下。</p>
<h4 id="commit到私有docker仓库"><a href="#commit到私有docker仓库" class="headerlink" title="commit到私有docker仓库"></a>commit到私有docker仓库</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker commit -m &quot;flask插件安装&quot; -a &quot;liubing&quot; $containId liubing/test-flask</span><br><span class="line">docker tag liubing/$imageName $dockerRegistsryAddress/test-flask</span><br><span class="line">docker push $dockerRegistsryAddress/test-flask</span><br></pre></td></tr></table></figure>

<p>db的docker也可提前commit到私有仓库。</p>
<h3 id="jenkins拉源码"><a href="#jenkins拉源码" class="headerlink" title="jenkins拉源码"></a>jenkins拉源码</h3><p>在jenkins中配置“源码管理”，输入source仓库的git地址，并绑定git用户及需要检测状态变化的branch。在构建时会自动下载git源码的。</p>
<p><img src="http://obksgg9lx.bkt.clouddn.com/git.png" alt="配置git地址"></p>
<h3 id="实现应用打包"><a href="#实现应用打包" class="headerlink" title="实现应用打包"></a>实现应用打包</h3><p>目前开发的是一个python项目，python不需要打包。源码即可执行。</p>
<h3 id="把应用打包进docker镜像"><a href="#把应用打包进docker镜像" class="headerlink" title="把应用打包进docker镜像"></a>把应用打包进docker镜像</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">echo &#x27;From $dockerRegistsryAddress/test-flask</span><br><span class="line">MAINTAINER liubing &quot;lbingg@hotmail.com&quot;</span><br><span class="line"></span><br><span class="line">COPY . /app</span><br><span class="line"></span><br><span class="line">&#x27; &gt; Dockerfile;</span><br></pre></td></tr></table></figure>
<p>jenkins中执行的脚本会默认当前脚本处于jenkins环境中的workspace中的当前应用工程下。因此在copy程序时，我们需要将当前目录下的所有文件全部拷贝入新创建docker镜像的/app目录中。</p>
<h3 id="镜像同步到docker私有仓库"><a href="#镜像同步到docker私有仓库" class="headerlink" title="镜像同步到docker私有仓库"></a>镜像同步到docker私有仓库</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker build -t $dockerRegistsryAddress/test-flask;</span><br></pre></td></tr></table></figure>
<h3 id="删除老的docker容器"><a href="#删除老的docker容器" class="headerlink" title="删除老的docker容器"></a>删除老的docker容器</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">docker stop postgresql || true;</span><br><span class="line">docker rm postgresql || true;</span><br><span class="line">docker stop test-flask || true;</span><br><span class="line">docker rm test-flask || true;</span><br></pre></td></tr></table></figure>

<h3 id="运行新的docker容器"><a href="#运行新的docker容器" class="headerlink" title="运行新的docker容器"></a>运行新的docker容器</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker run --name=postgresql -itd --restart always --publish 5432:5432 --volume /opt/postgresql/data:/var/lib/postgresql --env &#x27;DB_USER=postgres&#x27; --env &#x27;DB_PASS=postgres&#x27; --env &#x27;DB_NAME=postgres&#x27; $dockerRegistryAddress:5000/test-db-1;</span><br><span class="line"></span><br><span class="line">docker run --name test-flask --publish 80:80 --link postgresql:postgres -d $dockerRegistryAddress:5000/test-flask;</span><br></pre></td></tr></table></figure>

<p>jenkins中的“构建”配置</p>
<p><img src="http://obksgg9lx.bkt.clouddn.com/structure.png" alt="配置构建"></p>
<h3 id="问题点"><a href="#问题点" class="headerlink" title="问题点"></a>问题点</h3><p>需要在jenkins的docker中运行其他的docker命令，可以使用Docker outside of Docker来配置。<br><img src="http://liubing1545.github.io/2017/11/16/Docker-outside-of-Docker" alt="Docker-outside-of-Docker"></p>
 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <footer class="article-footer">
       
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/docker/" rel="tag">docker</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/jenkins/" rel="tag">jenkins</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E6%8C%81%E7%BB%AD%E9%83%A8%E7%BD%B2/" rel="tag">持续部署</a></li></ul>

    </footer>
  </div>

    
 
    
</article>

    
  </article>
  

  
  <nav class="page-nav">
    
    <a class="extend prev" rel="prev" href="/page/2/">上一页</a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><span class="page-number current">3</span><a class="page-number" href="/page/4/">4</a><a class="page-number" href="/page/5/">5</a><span class="space">&hellip;</span><a class="page-number" href="/page/7/">7</a><a class="extend next" rel="next" href="/page/4/">下一页</a>
  </nav>
  
</section>
</div>

      <footer class="footer">
  <div class="outer">
    <ul>
      <li>
        Copyrights &copy;
        2015-2021
        <i class="ri-heart-fill heart_icon"></i> 小白兔
      </li>
    </ul>
    <ul>
      <li>
        
        
        
        由 <a href="https://hexo.io" target="_blank">Hexo</a> 强力驱动
        <span class="division">|</span>
        主题 - <a href="https://github.com/Shen-Yu/hexo-theme-ayer" target="_blank">Ayer</a>
        
      </li>
    </ul>
    <ul>
      <li>
        
        
        <span>
  <span><i class="ri-user-3-fill"></i>访问人数:<span id="busuanzi_value_site_uv"></span></span>
  <span class="division">|</span>
  <span><i class="ri-eye-fill"></i>浏览次数:<span id="busuanzi_value_page_pv"></span></span>
</span>
        
      </li>
    </ul>
    <ul>
      
    </ul>
    <ul>
      
    </ul>
    <ul>
      <li>
        <!-- cnzz统计 -->
        
      </li>
    </ul>
  </div>
</footer>
      <div class="float_btns">
        <div class="totop" id="totop">
  <i class="ri-arrow-up-line"></i>
</div>

<div class="todark" id="todark">
  <i class="ri-moon-line"></i>
</div>

      </div>
    </main>
    <aside class="sidebar on">
      <button class="navbar-toggle"></button>
<nav class="navbar">
  
  <div class="logo">
    <a href="/"><img src="/images/ayer-side.svg" alt="白兔之家"></a>
  </div>
  
  <ul class="nav nav-main">
    
    <li class="nav-item">
      <a class="nav-item-link" href="/">主页</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/archives">归档</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/categories">分类</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/tags">标签</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/tags/poem/">诗歌</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/tags/trip/">旅行</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/friends">友链</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/2019/about">关于我</a>
    </li>
    
  </ul>
</nav>
<nav class="navbar navbar-bottom">
  <ul class="nav">
    <li class="nav-item">
      
      <a class="nav-item-link nav-item-search"  title="搜索">
        <i class="ri-search-line"></i>
      </a>
      
      
      <a class="nav-item-link" target="_blank" href="/atom.xml" title="RSS Feed">
        <i class="ri-rss-line"></i>
      </a>
      
    </li>
  </ul>
</nav>
<div class="search-form-wrap">
  <div class="local-search local-search-plugin">
  <input type="search" id="local-search-input" class="local-search-input" placeholder="Search...">
  <div id="local-search-result" class="local-search-result"></div>
</div>
</div>
    </aside>
    <div id="mask"></div>

<!-- #reward -->
<div id="reward">
  <span class="close"><i class="ri-close-line"></i></span>
  <p class="reward-p"><i class="ri-cup-line"></i>请我喝杯咖啡吧~</p>
  <div class="reward-box">
    
    <div class="reward-item">
      <img class="reward-img" src="https://cdn.jsdelivr.net/gh/Shen-Yu/cdn/img/alipay.jpg">
      <span class="reward-type">支付宝</span>
    </div>
    
    
    <div class="reward-item">
      <img class="reward-img" src="https://cdn.jsdelivr.net/gh/Shen-Yu/cdn/img/wechat.jpg">
      <span class="reward-type">微信</span>
    </div>
    
  </div>
</div>
    
<script src="/js/jquery-2.0.3.min.js"></script>
 
<script src="/js/lazyload.min.js"></script>

<!-- Tocbot -->

<script src="https://cdn.jsdelivr.net/npm/jquery-modal@0.9.2/jquery.modal.min.js"></script>
<link
  rel="stylesheet"
  href="https://cdn.jsdelivr.net/npm/jquery-modal@0.9.2/jquery.modal.min.css"
/>
<script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js"></script>

<script src="/dist/main.js"></script>

<!-- ImageViewer -->
 <!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    <!-- Background of PhotoSwipe. 
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>

    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">

        <!-- Container that holds slides. 
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                <!--  Controls are self-explanatory. Order can be changed. -->

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" style="display:none" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css">
<script src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js"></script>

<script>
    function viewer_init() {
        let pswpElement = document.querySelectorAll('.pswp')[0];
        let $imgArr = document.querySelectorAll(('.article-entry img:not(.reward-img)'))

        $imgArr.forEach(($em, i) => {
            $em.onclick = () => {
                // slider展开状态
                // todo: 这样不好，后面改成状态
                if (document.querySelector('.left-col.show')) return
                let items = []
                $imgArr.forEach(($em2, i2) => {
                    let img = $em2.getAttribute('data-idx', i2)
                    let src = $em2.getAttribute('data-target') || $em2.getAttribute('src')
                    let title = $em2.getAttribute('alt')
                    // 获得原图尺寸
                    const image = new Image()
                    image.src = src
                    items.push({
                        src: src,
                        w: image.width || $em2.width,
                        h: image.height || $em2.height,
                        title: title
                    })
                })
                var gallery = new PhotoSwipe(pswpElement, PhotoSwipeUI_Default, items, {
                    index: parseInt(i)
                });
                gallery.init()
            }
        })
    }
    viewer_init()
</script> 
<!-- MathJax -->

<!-- Katex -->

<!-- busuanzi  -->
 
<script src="/js/busuanzi-2.3.pure.min.js"></script>
 
<!-- ClickLove -->
 
<script src="/js/clickLove.js"></script>
 
<!-- ClickBoom1 -->

<!-- ClickBoom2 -->

<!-- CodeCopy -->
 
<link rel="stylesheet" href="/css/clipboard.css">
 <script src="https://cdn.jsdelivr.net/npm/clipboard@2/dist/clipboard.min.js"></script>
<script>
  function wait(callback, seconds) {
    var timelag = null;
    timelag = window.setTimeout(callback, seconds);
  }
  !function (e, t, a) {
    var initCopyCode = function(){
      var copyHtml = '';
      copyHtml += '<button class="btn-copy" data-clipboard-snippet="">';
      copyHtml += '<i class="ri-file-copy-2-line"></i><span>COPY</span>';
      copyHtml += '</button>';
      $(".highlight .code pre").before(copyHtml);
      $(".article pre code").before(copyHtml);
      var clipboard = new ClipboardJS('.btn-copy', {
        target: function(trigger) {
          return trigger.nextElementSibling;
        }
      });
      clipboard.on('success', function(e) {
        let $btn = $(e.trigger);
        $btn.addClass('copied');
        let $icon = $($btn.find('i'));
        $icon.removeClass('ri-file-copy-2-line');
        $icon.addClass('ri-checkbox-circle-line');
        let $span = $($btn.find('span'));
        $span[0].innerText = 'COPIED';
        
        wait(function () { // 等待两秒钟后恢复
          $icon.removeClass('ri-checkbox-circle-line');
          $icon.addClass('ri-file-copy-2-line');
          $span[0].innerText = 'COPY';
        }, 2000);
      });
      clipboard.on('error', function(e) {
        e.clearSelection();
        let $btn = $(e.trigger);
        $btn.addClass('copy-failed');
        let $icon = $($btn.find('i'));
        $icon.removeClass('ri-file-copy-2-line');
        $icon.addClass('ri-time-line');
        let $span = $($btn.find('span'));
        $span[0].innerText = 'COPY FAILED';
        
        wait(function () { // 等待两秒钟后恢复
          $icon.removeClass('ri-time-line');
          $icon.addClass('ri-file-copy-2-line');
          $span[0].innerText = 'COPY';
        }, 2000);
      });
    }
    initCopyCode();
  }(window, document);
</script>
 
<!-- CanvasBackground -->

<script>
  if (window.mermaid) {
    mermaid.initialize({ theme: "forest" });
  }
</script>


    
  </div>
<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/","tagMode":false});</script></body>

</html>